# 開発ToDoリスト

このリストは、シフト生成アプリケーション開発における今後のタスクと課題を管理します。

## フェーズ1: AIルール解釈 プロトタイピング (完了済み)

*   [x] **AIプロンプト詳細化 (2ステップアプローチ導入):**
    *   [x] ステップ1: 自然言語ルール → `(必須)`/`(推奨)`付き確認用文章 へ翻訳するプロンプトを作成 (個人・施設)。
    *   [x] ステップ2: 確認用文章 → `structured_data` JSONを生成するプロンプトを作成 (個人・施設)。
    *   [x] シーケンス分解、制約強度解釈、祝日休み（中間表現）への対応を指示。
    *   [x] 出力形式の厳密化（Markdown除去など）。
*   [x] **ルールパーサー (`rule_parser.py`) とメイン処理 (`shift_generator.py`) の修正:**
    *   [x] AIによって生成された `structured_data` を検証・変換するロジック (`validate_and_transform_rule`, `validate_facility_rule`) を実装・活用。
    *   [x] 日付の年補完・期間検証を実装。
    *   [x] `shift_generator.py` 内で、2ステップAIの出力を結合し、最終ルールリストを構築する処理を実装。
    *   [x] 個人ルールの「祝日休み」希望を検出し、期間内の祝日に対して`SPECIFY_DATE_SHIFT`ルールを自動展開するロジックを実装。
*   [x] **モデル構築 (`shift_model.py`) の修正:**
    *   [x] `is_hard` パラメータに基づき、主要な個人ルール・施設ルールでハード制約/ソフト制約の切り替えに対応。
    *   [x] 最終的に構築された構造化ルールデータを処理し、対応する制約・目標をモデルに追加。
    *   [x] ハードコードされていた施設ルール（人員配置など）を削除し、動的処理に変更。
    *   [ ] ソフト制約の重み (`weight`) の処理は現在仮実装（整数化）。要改善。
*   [x] **メイン処理 (`shift_generator.py`) の修正:**
    *   [x] 個人・施設ルールそれぞれの2ステップAI呼び出し、パーサー（検証）呼び出し、モデル構築・求解・出力のパイプラインを実装。
*   [x] **動作確認と評価:**
    *   [x] `rules.csv`, `facility_rules.txt` の内容で実行し、シフト生成と制約適用を確認。
    *   [x] 2ステップアプローチにより、シーケンス分解、祝日休み処理が改善されたことを確認。

## フェーズ2: 基本アプリケーション機能実装 (次フェーズ)

*   [ ] **データベース設計・実装:**
    *   [ ] 従業員情報、ルール（自然言語、中間確認文、構造化データ？）、シフト結果を格納するDBスキーマを確定し、マイグレーションを実装する。
    *   [ ] ORM (SQLAlchemyなど) を使った基本的なCRUD操作を実装する。
*   [ ] **バックエンドAPI実装:**
    *   [ ] 従業員情報、ルール設定のCRUD API。
    *   [ ] シフト生成リクエストAPI（非同期処理を検討）。
    *   [ ] 生成結果取得API。
*   [ ] **フロントエンド実装 (MVP):**
    *   [ ] 基本的な画面構成（ルール入力、中間確認、シフト表示）。
    *   [ ] 自然言語ルール入力UI。
    *   [ ] AIによる中間確認文表示と、ユーザーによる修正UI。
    *   [ ] シフト表示グリッド。
    *   [ ] API連携。
*   [ ] **基本設定の外部入力:**
    *   [ ] シフト開始日、期間をコマンドライン引数や設定ファイルで指定できるようにする。

## フェーズ3: AI連携 本格実装 (バックエンド/フロントエンド連携)

*   [ ] **AI API連携:** (バックエンド側)
    *   [ ] バックエンドからLLM APIを呼び出し、2ステップの整形・構造化処理を実行するモジュールを実装。
    *   [ ] APIキー管理。
*   [ ] **ユーザー確認・承認フロー:** (バックエンド + フロントエンド)
    *   [ ] ステップ1（中間確認文生成）の結果をUIに表示。
    *   [ ] ユーザーが内容を確認し、承認または修正指示（`(必須)`/`(推奨)` 調整含む）を行えるUIとバックエンドロジック。
    *   [ ] 修正された確認文を元にステップ2（`structured_data` 生成）を実行。
*   [ ] **ルール永続化:**
    *   [ ] ユーザーが承認した最終的な構造化ルール（と対応する確認文）をDBに保存する。

## フェーズ4: 機能拡張・改善 (将来)

*   [ ] **施設全体ルールのカスタマイズUI:**
*   [ ] **OR-Toolsモデル改善:**
    *   [ ] ソフト制約の重み付け (`weight`) の処理を改善する。（フェーズ1からの残り）
    *   [ ] 応援勤務のより詳細なモデリング。
    *   [ ] ソフト制約の重み付けをユーザーが調整できる機能。
*   [ ] **UI/UX改善:**
    *   [ ] シフトの手動調整機能。
    *   [ ] 統計情報（個人別勤務日数、休日数など）の表示。
    *   [ ] 見た目の改善。
*   [ ] **エラーハンドリング強化:**
    *   [ ] `INFEASIBLE` 時の原因推定とユーザーへのフィードバック改善。
    *   [ ] AI解釈エラー時のより親切なガイド。

## その他

*   [ ] テストコードの実装（単体テスト、結合テスト）
*   [ ] ドキュメント整備（README更新、コードコメント）
*   [ ] デプロイ環境構築
*   [ ] ロギング・モニタリング
*   [ ] デバッグ用プリント文の整理・削除 